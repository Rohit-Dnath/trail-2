(()=>{"use strict";class e{static async getGeminiApiKey(){try{return(await chrome.storage.sync.get([this.API_KEY_STORAGE_KEY]))[this.API_KEY_STORAGE_KEY]||this.DEFAULT_API_KEY}catch(e){return console.warn("Failed to get API key from storage, using default:",e),this.DEFAULT_API_KEY}}static async setGeminiApiKey(e){try{await chrome.storage.sync.set({[this.API_KEY_STORAGE_KEY]:e}),console.log("API key saved successfully")}catch(e){throw console.error("Failed to save API key:",e),e}}static async clearGeminiApiKey(){try{await chrome.storage.sync.remove([this.API_KEY_STORAGE_KEY]),console.log("API key cleared, reverting to default")}catch(e){throw console.error("Failed to clear API key:",e),e}}static async hasCustomApiKey(){try{return!!(await chrome.storage.sync.get([this.API_KEY_STORAGE_KEY]))[this.API_KEY_STORAGE_KEY]}catch(e){return!1}}static async initialize(){try{await this.hasCustomApiKey()||console.log("Initializing with default API key")}catch(e){console.error("Failed to initialize config manager:",e)}}static validateApiKey(e){return"string"==typeof e&&e.length>20&&e.startsWith("AIza")}static getConfig(){return{isDevelopment:!1,apiEndpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",rateLimitDelay:1e3,maxRetries:3,requestTimeout:3e4}}}e.API_KEY_STORAGE_KEY="traily_gemini_api_key",e.DEFAULT_API_KEY="AIzaSyBUKv9TXCEkttL3vxjguPlrd7YG-LYFXuU";class t{constructor(){this.apiKey="",this.config=e.getConfig(),this.rateLimitQueue=[],this.isProcessing=!1,this.lastApiCall=0,this.initializeApiKey()}async initializeApiKey(){try{this.apiKey=await e.getGeminiApiKey(),console.log("Gemini API key initialized")}catch(e){console.error("Failed to initialize Gemini API key:",e)}}async setApiKey(t){if(!e.validateApiKey(t))throw new Error("Invalid API key format");this.apiKey=t,await e.setGeminiApiKey(t),console.log("Gemini API key updated")}async analyzeContent(e,t){if(!this.apiKey)return console.warn("Gemini API key not configured"),null;const a=`Analyze this web content and extract information in JSON format:\n\nContent URL: ${t}\nContent: ${e.substring(0,4e3)} ${e.length>4e3?"...[truncated]":""}\n\nPlease provide a JSON response with the following structure:\n{\n  "concepts": ["concept1", "concept2", ...] (max 10 key concepts/topics),\n  "summary": "2-3 sentence summary",\n  "contentType": "research|documentation|news|blog|article|tutorial",\n  "author": "author name if mentioned, null otherwise",\n  "mainTopic": "primary topic/theme",\n  "relatedTopics": ["topic1", "topic2", ...] (max 5 related topics),\n  "confidence": 0.8 (confidence score 0-1)\n}\n\nFocus on extracting meaningful concepts that could be useful for building knowledge connections.`;try{const e=await this.callGeminiAPI(a);return this.parseGeminiResponse(e)}catch(e){return console.error("Gemini analysis failed:",e),null}}async findRelationships(e,t){if(!this.apiKey||0===t.length)return[];const a=`Given this new content and existing concepts, identify relationships:\n\nNew Content: ${e.substring(0,2e3)}\nExisting Concepts: ${t.join(", ")}\n\nReturn a JSON array of relationships:\n[\n  {"concept": "existing_concept", "similarity": 0.8, "relationship": "strongly_related"},\n  ...\n]\n\nOnly include relationships with similarity > 0.3. Max 10 relationships.`;try{const e=await this.callGeminiAPI(a);return this.parseRelationshipsResponse(e)}catch(e){return console.error("Relationship analysis failed:",e),[]}}async semanticSearch(e){if(!this.apiKey)return[];const t=`Analyze this search query and generate semantic variations:\n\nQuery: ${e}\n\nProvide JSON response:\n{\n  "semanticVariations": ["variation1", "variation2", ...],\n  "relatedConcepts": ["concept1", "concept2", ...],\n  "searchIntent": "research|general|specific_topic|comparison",\n  "keyTerms": ["term1", "term2", ...]\n}`;try{const e=await this.callGeminiAPI(t),a=this.parseSearchResponse(e);return[{relevanceScore:1,matchedConcepts:a.relatedConcepts||[],contentSnippet:`Search analysis: ${a.searchIntent}`}]}catch(e){return console.error("Semantic search failed:",e),[]}}async callGeminiAPI(e){return new Promise((t,a)=>{this.rateLimitQueue.push(async()=>{try{const a=Date.now()-this.lastApiCall;a<this.config.rateLimitDelay&&await new Promise(e=>setTimeout(e,this.config.rateLimitDelay-a));const n=await fetch(`${this.config.apiEndpoint}?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:e}]}],generationConfig:{temperature:.3,topK:20,topP:.8,maxOutputTokens:2048}})});if(this.lastApiCall=Date.now(),!n.ok)throw new Error(`Gemini API error: ${n.status} ${n.statusText}`);const s=await n.json();if(!s.candidates||!s.candidates[0]?.content?.parts?.[0]?.text)throw new Error("Invalid response format from Gemini API");t(s.candidates[0].content.parts[0].text)}catch(e){a(e)}}),this.isProcessing||this.processQueue()})}async processQueue(){for(this.isProcessing=!0;this.rateLimitQueue.length>0;){const e=this.rateLimitQueue.shift();if(e)try{await e()}catch(e){console.error("Queue task failed:",e)}}this.isProcessing=!1}parseGeminiResponse(e){try{const t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),a=JSON.parse(t);return{concepts:Array.isArray(a.concepts)?a.concepts.slice(0,10):[],summary:a.summary||"",contentType:a.contentType||"article",author:a.author||void 0,mainTopic:a.mainTopic||"",relatedTopics:Array.isArray(a.relatedTopics)?a.relatedTopics.slice(0,5):[],confidence:"number"==typeof a.confidence?a.confidence:.5}}catch(e){return console.error("Failed to parse Gemini response:",e),null}}parseRelationshipsResponse(e){try{const t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),a=JSON.parse(t);return Array.isArray(a)?a.filter(e=>e.concept&&"number"==typeof e.similarity).slice(0,10):[]}catch(e){return console.error("Failed to parse relationships response:",e),[]}}parseSearchResponse(e){try{const t=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();return JSON.parse(t)}catch(e){return console.error("Failed to parse search response:",e),{semanticVariations:[],relatedConcepts:[],searchIntent:"general",keyTerms:[]}}}async testConnection(){if(!this.apiKey)return!1;try{const e=await this.callGeminiAPI('Test connection. Respond with: {"status": "connected"}');return"connected"===JSON.parse(e.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim()).status}catch(e){return console.error("Gemini connection test failed:",e),!1}}}class a{constructor(){this.STORAGE_KEYS={NODES:"traily_graph_nodes",EDGES:"traily_graph_edges",CONTENT:"traily_content",SETTINGS:"traily_settings",LAST_CLEANUP:"traily_last_cleanup"},this.DEFAULT_SETTINGS={geminiApiKey:"",autoCapture:!0,minContentLength:500,skipDomains:["facebook.com","twitter.com","instagram.com","youtube.com"],captureFrequency:2e3,maxStorageSize:104857600},this.scheduleCleanup()}async initializeSettings(){try{(await chrome.storage.sync.get(this.STORAGE_KEYS.SETTINGS))[this.STORAGE_KEYS.SETTINGS]||await chrome.storage.sync.set({[this.STORAGE_KEYS.SETTINGS]:this.DEFAULT_SETTINGS})}catch(e){console.error("Failed to initialize settings:",e)}}async getSettings(){try{const e=await chrome.storage.sync.get(this.STORAGE_KEYS.SETTINGS);return{...this.DEFAULT_SETTINGS,...e[this.STORAGE_KEYS.SETTINGS]}}catch(e){return console.error("Failed to get settings:",e),this.DEFAULT_SETTINGS}}async updateSettings(e){try{const t={...await this.getSettings(),...e};await chrome.storage.sync.set({[this.STORAGE_KEYS.SETTINGS]:t})}catch(e){console.error("Failed to update settings:",e)}}async storeProcessedContent(e){try{const t=((await chrome.storage.local.get(this.STORAGE_KEYS.CONTENT))[this.STORAGE_KEYS.CONTENT]||[]).filter(t=>t.url!==e.url);t.push(e);const a=t.sort((e,t)=>t.timestamp-e.timestamp).slice(0,1e3);await chrome.storage.local.set({[this.STORAGE_KEYS.CONTENT]:a})}catch(e){console.error("Failed to store content:",e)}}async findSimilarContent(e){try{return((await chrome.storage.local.get(this.STORAGE_KEYS.CONTENT))[this.STORAGE_KEYS.CONTENT]||[]).find(t=>t.url===e)||null}catch(e){return console.error("Failed to find similar content:",e),null}}async searchContent(e){try{const t=(await chrome.storage.local.get(this.STORAGE_KEYS.CONTENT))[this.STORAGE_KEYS.CONTENT]||[],a=e.toLowerCase();return t.filter(e=>e.title.toLowerCase().includes(a)||e.content.toLowerCase().includes(a)||e.analysis?.concepts&&e.analysis.concepts.some(e=>e.toLowerCase().includes(a))).slice(0,50)}catch(e){return console.error("Failed to search content:",e),[]}}async addGraphNode(e){try{const t=((await chrome.storage.local.get(this.STORAGE_KEYS.NODES))[this.STORAGE_KEYS.NODES]||[]).filter(t=>t.id!==e.id);t.push(e),await chrome.storage.local.set({[this.STORAGE_KEYS.NODES]:t})}catch(e){console.error("Failed to add graph node:",e)}}async getGraphNode(e){try{return((await chrome.storage.local.get(this.STORAGE_KEYS.NODES))[this.STORAGE_KEYS.NODES]||[]).find(t=>t.id===e)||null}catch(e){return console.error("Failed to get graph node:",e),null}}async updateGraphNode(e){try{const t=(await chrome.storage.local.get(this.STORAGE_KEYS.NODES))[this.STORAGE_KEYS.NODES]||[],a=t.findIndex(t=>t.id===e.id);-1!==a&&(t[a]=e,await chrome.storage.local.set({[this.STORAGE_KEYS.NODES]:t}))}catch(e){console.error("Failed to update graph node:",e)}}async addGraphEdge(e){try{const t=(await chrome.storage.local.get(this.STORAGE_KEYS.EDGES))[this.STORAGE_KEYS.EDGES]||[];t.find(t=>t.id===e.id)||(t.push(e),await chrome.storage.local.set({[this.STORAGE_KEYS.EDGES]:t}))}catch(e){console.error("Failed to add graph edge:",e)}}async getGraphData(){try{const[e,t]=await Promise.all([chrome.storage.local.get(this.STORAGE_KEYS.NODES),chrome.storage.local.get(this.STORAGE_KEYS.EDGES)]);return{nodes:e[this.STORAGE_KEYS.NODES]||[],edges:t[this.STORAGE_KEYS.EDGES]||[]}}catch(e){return console.error("Failed to get graph data:",e),{nodes:[],edges:[]}}}async getStorageUsage(){try{return{bytesInUse:await chrome.storage.local.getBytesInUse(),maxBytes:chrome.storage.local.QUOTA_BYTES||10485760}}catch(e){return console.error("Failed to get storage usage:",e),{bytesInUse:0,maxBytes:10485760}}}async clearOldData(e=6048e5){try{const t=Date.now()-e,a=((await chrome.storage.local.get(this.STORAGE_KEYS.CONTENT))[this.STORAGE_KEYS.CONTENT]||[]).filter(e=>e.timestamp>t),n=((await chrome.storage.local.get(this.STORAGE_KEYS.NODES))[this.STORAGE_KEYS.NODES]||[]).filter(e=>!e.data.timestamp||e.data.timestamp>t);await chrome.storage.local.set({[this.STORAGE_KEYS.CONTENT]:a,[this.STORAGE_KEYS.NODES]:n,[this.STORAGE_KEYS.LAST_CLEANUP]:Date.now()}),console.log(`Cleaned up old data. Kept ${a.length} content items and ${n.length} nodes.`)}catch(e){console.error("Failed to clean old data:",e)}}async scheduleCleanup(){try{const e=(await chrome.storage.local.get(this.STORAGE_KEYS.LAST_CLEANUP))[this.STORAGE_KEYS.LAST_CLEANUP]||0;(Date.now()-e)/864e5>1&&await this.clearOldData()}catch(e){console.error("Failed to schedule cleanup:",e)}}async exportData(){try{const[e,t]=await Promise.all([chrome.storage.local.get(this.STORAGE_KEYS.CONTENT),this.getGraphData()]);return{content:e[this.STORAGE_KEYS.CONTENT]||[],graphData:t}}catch(e){return console.error("Failed to export data:",e),{content:[],graphData:{nodes:[],edges:[]}}}}async clearAllData(){try{await chrome.storage.local.clear(),await this.initializeSettings(),console.log("All data cleared successfully")}catch(e){console.error("Failed to clear all data:",e)}}}class n{combineSearchResults(e,t){const a=[];return t.forEach(e=>{const t={content:e,relevanceScore:this.calculateRelevanceScore(e),matchType:"content",snippet:this.generateSnippet(e.content)};a.push(t)}),e.forEach(e=>{a.forEach(t=>{this.hasSemanticMatch(t.content,e.matchedConcepts)&&(t.relevanceScore+=.5*e.relevanceScore,t.matchType="semantic")})}),a.sort((e,t)=>t.relevanceScore-e.relevanceScore).slice(0,20)}calculateRelevanceScore(e){let t=0;switch(e.metadata.contentType){case"research":t+=3;break;case"documentation":t+=2.5;break;case"article":t+=2;break;case"blog":t+=1.5;break;default:t+=1}const a=(Date.now()-e.timestamp)/864e5;return a<7?t+=1:a<30&&(t+=.5),e.metadata.wordCount>2e3?t+=1:e.metadata.wordCount>1e3&&(t+=.5),e.analysis?.confidence&&(t+=e.analysis.confidence),t}hasSemanticMatch(e,t){if(!e.analysis?.concepts)return!1;const a=e.analysis.concepts.map(e=>e.toLowerCase());return t.some(e=>a.some(t=>t.includes(e.toLowerCase())||e.toLowerCase().includes(t)))}generateSnippet(e,t=200){if(e.length<=t)return e;const a=e.substring(0,t),n=a.lastIndexOf(". ");if(n>.7*t)return a.substring(0,n+1);const s=a.lastIndexOf(" ");return a.substring(0,s)+"..."}extractKeywords(e){const t=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>3),a={};return t.forEach(e=>{a[e]=(a[e]||0)+1}),Object.entries(a).sort(([,e],[,t])=>t-e).slice(0,10).map(([e])=>e)}categorizeContent(e,t,a){const n=[];let s="general",r=.5;const o=e.toLowerCase(),i=t.toLowerCase(),c=new URL(a).hostname;return["abstract","methodology","results","conclusion","literature review","hypothesis","experiment"].some(e=>o.includes(e)||i.includes(e))&&(s="research",r+=.3,n.push("research patterns detected")),["documentation","api","tutorial","guide","installation","configuration","usage"].some(e=>o.includes(e)||i.includes(e))&&(s="documentation",r+=.25,n.push("documentation patterns detected")),(c.includes("news")||i.includes("breaking")||i.includes("reported")||/\b(today|yesterday|this morning)\b/.test(i))&&(s="news",r+=.2,n.push("news patterns detected")),["function","class","method","algorithm","implementation","code","programming"].some(e=>i.includes(e))&&("general"===s&&(s="technical"),r+=.15,n.push("technical content detected")),{category:s,confidence:Math.min(r,1),indicators:n}}filterContentByQuality(e,t=.5){return this.calculateQualityScore(e).overall>=t}calculateQualityScore(e){const t=e.split(/\s+/).length;let a=0;t>=500&&t<=5e3?a=1:t>=200&&t<500?a=.7:t>5e3&&t<=1e4?a=.8:t>=100&&(a=.4);const n=e.split(/\n\s*\n/).length,s=e.split(/[.!?]+/).length,r=t/s;let o=0;n>1&&(o+=.3),s>5&&(o+=.3),r>=10&&r<=25&&(o+=.4);const i=e.replace(/\s+/g,"").length/t;let c=0;return i>=4&&i<=6&&(c+=.5),(e.includes(",")||e.includes(";"))&&(c+=.3),/[A-Z]/.test(e)&&(c+=.2),{overall:(a+o+c)/3,length:a,structure:o,readability:c}}}new class{constructor(){this.isProcessing=new Set,this.geminiProcessor=new t,this.storageManager=new a,this.contentProcessor=new n,this.setupEventListeners()}setupEventListeners(){chrome.tabs.onUpdated.addListener((e,t,a)=>{"complete"===t.status&&a.url&&this.shouldProcessUrl(a.url)&&this.processTab(a)}),chrome.runtime.onMessage.addListener((e,t,a)=>(this.handleMessage(e,t,a),!0)),chrome.runtime.onInstalled.addListener(()=>{this.initializeExtension()})}shouldProcessUrl(e){const t=["facebook.com","twitter.com","instagram.com","youtube.com"],a=["chrome:","chrome-extension:","moz-extension:"];try{const n=new URL(e);return!a.some(t=>e.startsWith(t))&&!t.some(e=>n.hostname.includes(e))}catch{return!1}}async processTab(e){if(e.id&&e.url&&!this.isProcessing.has(e.url)){this.isProcessing.add(e.url);try{const t=await chrome.scripting.executeScript({target:{tabId:e.id},func:this.extractPageContent});if(t&&t[0]?.result){const e=t[0].result;await this.processContent(e)}}catch(e){console.error("Error processing tab:",e)}finally{this.isProcessing.delete(e.url)}}}extractPageContent(){try{const e=document.title,t=window.location.href,a=["article",'[role="main"]',"main",".content",".post-content",".entry-content",".article-body"];let n=null;for(const e of a)if(n=document.querySelector(e),n)break;n||(n=document.body);const s=n.cloneNode(!0);["script","style","nav","header","footer",".ads",".advertisement",".social-share",".comments",".sidebar",".menu"].forEach(e=>{s.querySelectorAll(e).forEach(e=>e.remove())});const r=s.textContent||"",o=r.trim().split(/\s+/).length;if(o<100)return null;const i=new URL(t).hostname;return{url:t,title:e,content:r.trim(),timestamp:Date.now(),metadata:{domain:i,contentType:this.detectContentType(e,r),wordCount:o}}}catch(e){return console.error("Content extraction error:",e),null}}detectContentType(e,t){const a=e.toLowerCase(),n=t.toLowerCase();return a.includes("research")||a.includes("paper")||n.includes("abstract")||n.includes("methodology")?"research":a.includes("documentation")||a.includes("docs")||n.includes("api")||n.includes("tutorial")?"documentation":a.includes("news")||n.includes("breaking")||n.includes("reported")?"news":a.includes("blog")||n.includes("published by")||n.includes("opinion")?"blog":"article"}async processContent(e){try{if(await this.storageManager.findSimilarContent(e.url))return void console.log("Similar content already exists, skipping");const t=await this.geminiProcessor.analyzeContent(e.content,e.url);t&&(await this.storageManager.storeProcessedContent({...e,analysis:t,nodeId:this.generateNodeId(e.url)}),await this.updateKnowledgeGraph(e,t),console.log("Content processed and stored:",e.title))}catch(e){console.error("Error processing content:",e)}}generateNodeId(e){return btoa(e).replace(/[+/=]/g,"").substring(0,16)}async updateKnowledgeGraph(e,t){const a={id:this.generateNodeId(e.url),type:"page",data:{label:e.title,url:e.url,summary:t.summary,timestamp:e.timestamp,importance:this.calculateImportance(e,t),domain:e.metadata.domain,contentType:e.metadata.contentType},position:{x:400*Math.random(),y:400*Math.random()}};if(await this.storageManager.addGraphNode(a),t.concepts&&Array.isArray(t.concepts))for(const e of t.concepts)await this.processConceptNode(e,a.id)}calculateImportance(e,t){let a=0;return a+=Math.min(e.metadata.wordCount/1e3,5),"research"===e.metadata.contentType&&(a+=3),"documentation"===e.metadata.contentType&&(a+=2),t.concepts&&(a+=Math.min(.5*t.concepts.length,3)),Math.min(a,10)}async processConceptNode(e,t){const a=this.generateNodeId(`concept:${e}`),n=await this.storageManager.getGraphNode(a);if(n){const e={...n,data:{...n.data,importance:n.data.importance+.5,connectedPages:[...n.data.connectedPages||[],t]}};await this.storageManager.updateGraphNode(e)}else{const n={id:a,type:"concept",data:{label:e,importance:1,connectedPages:[t]},position:{x:400*Math.random(),y:400*Math.random()}};await this.storageManager.addGraphNode(n)}const s={id:`${t}-${a}`,source:t,target:a,type:"relates_to",data:{strength:1,relationship:"contains_concept"}};await this.storageManager.addGraphEdge(s)}async handleMessage(e,t,a){try{switch(e.type){case"GET_GRAPH_DATA":a({success:!0,data:await this.storageManager.getGraphData()});break;case"SEARCH_CONTENT":a({success:!0,data:await this.performSearch(e.query)});break;case"UPDATE_SETTINGS":await this.storageManager.updateSettings(e.settings),a({success:!0});break;default:a({success:!1,error:"Unknown message type"})}}catch(e){console.error("Message handling error:",e),a({success:!1,error:e.message})}}async performSearch(e){const t=await this.geminiProcessor.semanticSearch(e),a=await this.storageManager.searchContent(e);return this.contentProcessor.combineSearchResults(t,a)}async initializeExtension(){console.log("Traily extension initialized"),await e.initialize(),await this.storageManager.initializeSettings(),await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})}}})();
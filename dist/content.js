(()=>{class t{constructor(){this.isProcessing=!1,this.lastExtractionTime=0,this.minExtractionInterval=5e3,this.init()}init(){Date.now()-this.lastExtractionTime<this.minExtractionInterval||("complete"===document.readyState?this.processPage():window.addEventListener("load",()=>this.processPage()))}async processPage(){if(!this.isProcessing&&this.shouldProcessPage()){this.isProcessing=!0,this.lastExtractionTime=Date.now();try{console.log("Traily: Processing page:",window.location.href);const t=this.extractPageContent();t&&this.isContentValid(t)?(console.log("Traily: Sending content to background script:",t),chrome.runtime.sendMessage({type:"PROCESS_CONTENT",data:t},t=>{t?.success?console.log("Traily: Content processed successfully"):console.error("Traily: Failed to process content:",t)})):console.log("Traily: Content not valid or sufficient for processing")}catch(t){console.error("Content extraction failed:",t)}finally{this.isProcessing=!1}}}shouldProcessPage(){const t=window.location.href;return!t.startsWith("chrome://")&&!t.startsWith("chrome-extension://")&&![/facebook\.com/,/twitter\.com/,/instagram\.com/,/youtube\.com\/watch/,/\.pdf$/,/\.(jpg|jpeg|png|gif|svg)$/i].some(e=>e.test(t))}extractPageContent(){try{const t=window.location.href,e=this.extractTitle(),n=this.extractMainContent();if(!n||n.length<100)return null;const o=n.trim().split(/\s+/).length,r=new URL(t).hostname,s=this.detectContentType(e,n,t);return{url:t,title:e,content:n.trim(),timestamp:Date.now(),metadata:{domain:r,contentType:s,wordCount:o}}}catch(t){return console.error("Content extraction error:",t),null}}extractTitle(){let t="";const e=document.querySelector('meta[property="og:title"]');if(e?.content&&(t=e.content),!t){const e=document.querySelector('meta[name="twitter:title"]');e?.content&&(t=e.content)}if(!t){const e=document.querySelector("h1");e?.textContent&&(t=e.textContent.trim())}return t||(t=document.title),t.trim()}extractMainContent(){const t=["article",'[role="main"]',"main",".content",".post-content",".entry-content",".article-body",".story-body",".post-body",".content-body"];for(const e of t){const t=document.querySelector(e);if(t)return this.cleanContent(t)}const e=this.findLargestTextBlocks();return e.length>0?e.map(t=>this.cleanContent(t)).join("\n\n"):this.cleanContent(document.body,!0)}findLargestTextBlocks(){const t=[];return document.querySelectorAll("p, div").forEach(e=>{const n=(e.textContent||"").trim().split(/\s+/).length;n>20&&t.push({element:e,score:n})}),t.sort((t,e)=>e.score-t.score).slice(0,5).map(t=>t.element)}cleanContent(t,e=!1){if(!t)return"";const n=t.cloneNode(!0),o=["script","style","noscript",".ad",".ads",".advertisement",".sponsor",".social-share",".share-buttons",".comments",".comment-form","nav","header","footer",".sidebar",".widget",".menu",".navigation"];e&&o.push(".related-articles",".recommended",".newsletter",".subscription",".popup",".modal",".cookie-notice"),o.forEach(t=>{n.querySelectorAll(t).forEach(t=>t.remove())});let r=n.textContent||"";return r=r.replace(/\s+/g," ").replace(/\n\s*\n/g,"\n").trim(),r}detectContentType(t,e,n){const o=t.toLowerCase(),r=e.toLowerCase(),s=new URL(n).hostname;return o.match(/\b(research|paper|study|analysis)\b/)||r.match(/\b(abstract|methodology|results|conclusion|literature review)\b/)?"research":o.match(/\b(documentation|docs|api|tutorial|guide)\b/)||s.includes("docs")||r.match(/\b(installation|configuration|usage|example)\b/)?"documentation":s.includes("news")||o.match(/\b(breaking|reported|announced)\b/)||r.match(/\b(breaking news|reported|according to)\b/)?"news":o.match(/\b(blog|post|opinion)\b/)||r.match(/\b(published by|written by|author)\b/)||n.includes("/blog/")?"blog":r.match(/\b(function|class|method|algorithm|code|programming)\b/)?"technical":"article"}isContentValid(t){return!(t.metadata.wordCount<50)&&(!![/\b(the|this|that|what|how|why|when|where)\b/i,/\b(because|therefore|however|although|since)\b/i,/\.[A-Z]/,/\w+ing\b/,/\w+ed\b/].some(e=>e.test(t.content))&&![/^(home|index|menu|navigation|sitemap)$/i,/^(404|error|not found)$/i,/^(login|register|signup)$/i].some(e=>e.test(t.title)))}}try{new t}catch(t){console.error("Traily content script initialization failed:",t)}})();